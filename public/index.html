<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CI/CD Dashboard</title>
  <style>:root {
  /* Light Mode Colors */
  --bg-primary: #f0f2f5; /* Overall page background */
  --bg-secondary: #ffffff; /* Card and main content background */
  --bg-sidebar: #2c3e50; /* Dark blue for sidebar */
  --text-primary: #333;
  --text-secondary: #666;
  --heading-color: #2c3e50;
  --border-color: #e0e0e0;
  --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --card-inner-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  --code-bg: #e9ecef;
  --code-color: #c7254e;
  --log-item-bg: #f9f9f9;
  --log-border-light: #eee;
  --log-output-bg: #2d2d2d;
  --log-output-color: #f8f8f2;
  --sidebar-text: #ecf0f1; /* Light text for sidebar */
  --sidebar-link-hover: #34495e; /* Darker hover for sidebar links */
  --sidebar-link-active: #007bff; /* Accent for active sidebar link */
  --sidebar-link-active-bg: rgba(0, 123, 255, 0.1); /* Light background for active link */
  --input-bg: #ffffff;
  --main-title-color: #2c3e50;
}

.dark-mode {
  /* Dark Mode Colors */
  --bg-primary: #121212; /* Very dark background */
  --bg-secondary: #1e1e1e; /* Slightly lighter for cards/main content */
  --bg-sidebar: #0a0a0a; /* Even darker for sidebar, strong contrast */
  --text-primary: #e0e0e0;
  --text-secondary: #a0a0a0;
  --heading-color: #f0f0f0;
  --border-color: #333333;
  --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); /* More pronounced shadow */
  --card-inner-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --code-bg: #2a2a2a;
  --code-color: #8be9fd; /* A light blue/cyan for code, common in dark themes */
  --log-item-bg: #252525;
  --log-border-light: #444444;
  --log-output-bg: #0d0d0d;
  --log-output-color: #e0e0e0;
  --sidebar-text: #e0e0e0;
  --sidebar-link-hover: #2a2a2a;
  --sidebar-link-active: #007bff;
  --sidebar-link-active-bg: rgba(0, 123, 255, 0.25); /* Slightly more opaque */
  --input-bg: #2a2a2a;
  --main-title-color: #f0f0f0;
}

body {
  font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif,
    "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  margin: 0;
  padding: 0;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  transition: background-color 0.3s, color 0.3s;
  min-height: 100vh;
  display: flex;
}

.dashboard-layout {
  display: flex;
  width: 100%;
  min-height: 100vh;
}

/* Sidebar Styling */
.sidebar {
  width: 250px;
  min-width: 250px;
  background-color: var(--bg-sidebar);
  color: var(--sidebar-text);
  padding: 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
}

.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-header .logo {
  font-size: 1.8em;
  font-weight: 700;
  margin: 0;
  color: #007bff;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-header .logo i {
  font-size: 1.2em;
}

.sidebar-nav {
  flex-grow: 1;
}

.sidebar-nav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.sidebar-nav li {
  margin-bottom: 8px;
}

.sidebar-nav a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 15px;
  color: var(--sidebar-text);
  text-decoration: none;
  font-size: 1.05em;
  border-radius: 6px;
  transition: background-color 0.2s, color 0.2s;
}

.sidebar-nav a i {
  font-size: 1.1em;
  color: var(--sidebar-text);
  transition: color 0.2s;
}

.sidebar-nav a:hover {
  background-color: var(--sidebar-link-hover);
  color: white;
}

.sidebar-nav a:hover i {
  color: white;
}

.sidebar-nav a.active {
  background-color: var(--sidebar-link-active-bg);
  color: var(--sidebar-link-active);
  font-weight: 600;
}

.sidebar-nav a.active i {
  color: var(--sidebar-link-active);
}

.sidebar-footer {
  padding-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-footer .full-width {
  width: 100%;
  justify-content: center;
}

/* Main Content Area */
.main-content {
  flex-grow: 1;
  padding: 30px; /* Increased padding */
  overflow-y: auto;
}

.main-content-header {
  margin-bottom: 30px;
}

.main-title {
  font-size: 2.2em;
  font-weight: 700;
  color: var(--main-title-color);
  margin: 0;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--border-color);
  transition: color 0.3s, border-color 0.3s;
}

.container {
  max-width: 100%;
  margin: 0 auto;
  background-color: var(--bg-primary);
  padding: 0;
  border-radius: 0;
  box-shadow: none;
  transition: background-color 0.3s;
}

section {
  margin-bottom: 40px;
  padding: 0;
  border: none;
  background-color: transparent;
}

section h2 {
  color: var(--heading-color);
  margin-top: 0;
  margin-bottom: 20px;
  font-size: 1.8em;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

section h2 i {
  color: #007bff;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.header h2 {
  margin-bottom: 0;
  border-bottom: none;
  padding-bottom: 0;
}

.card {
  background-color: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: var(--card-inner-shadow);
  transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}

.card h3 {
  color: var(--heading-color);
  margin-top: 0;
  margin-bottom: 0;
  font-size: 1.4em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card h3 i {
  color: #007bff;
}

.form-group {
  margin-bottom: 18px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text-secondary);
}

.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="url"] {
  width: calc(100% - 20px);
  padding: 12px 10px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 1em;
  box-sizing: border-box;
  background-color: var(--input-bg);
  color: var(--text-primary);
  transition: border-color 0.2s, background-color 0.2s, color 0.2s;
}

.form-group input[type="text"]:focus,
.form-group input[type="password"]:focus,
.form-group input[type="url"]:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
}

.form-group input[type="text"][readonly] {
  background-color: var(--code-bg);
  cursor: not-allowed;
}

.button {
  padding: 12px 25px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1em;
  font-weight: 600;
  transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
  margin-right: 10px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.button:last-child {
  margin-right: 0;
}

.button.primary {
  background-color: #007bff;
  color: white;
}

.button.primary:hover {
  background-color: #0056b3;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
}

.button.secondary {
  background-color: #6c757d;
  color: white;
}

.button.secondary:hover {
  background-color: #5a6268;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
}

.button.danger {
  background-color: #dc3545;
  color: white;
}

.button.danger:hover {
  background-color: #c82333;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
}

.button.small {
  padding: 8px 15px;
  font-size: 0.85em;
}

.button.icon-button {
  background: none;
  border: none;
  color: var(--sidebar-text);
  font-size: 1.5em;
  padding: 5px;
  margin: 0;
  transition: color 0.2s;
}

.button.icon-button:hover {
  color: #007bff;
  transform: none;
  box-shadow: none;
}

.message {
  margin-top: 15px;
  padding: 10px;
  border-radius: 5px;
  font-weight: 500;
}

.message.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.message.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.hidden {
  display: none;
}

.list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.list-item {
  background-color: var(--log-item-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 10px;
  word-wrap: break-word;
  white-space: pre-wrap;
  transition: background-color 0.3s, border-color 0.3s;
}

.list-item:last-child {
  margin-bottom: 0;
}

.list-item a {
  color: #007bff;
  text-decoration: none;
}

.list-item a:hover {
  text-decoration: underline;
}

.list-item code {
  background-color: var(--code-bg);
  padding: 3px 6px;
  border-radius: 3px;
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 0.9em;
  color: var(--code-color);
  transition: background-color 0.3s, color 0.3s;
}

.list-item i {
  margin-right: 5px;
  color: var(--text-secondary);
}

.project-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.logs-list .log-item {
  border-left: 5px solid;
}

.logs-list .log-status-started {
  border-color: #ffc107;
}
.logs-list .log-status-completed {
  border-color: #28a745;
}
.logs-list .log-status-failed {
  border-color: #dc3545;
}
.logs-list .log-status-unknown {
  border-color: #6c757d;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px dashed var(--log-border-light);
}

.log-time {
  font-size: 0.85em;
  color: var(--text-secondary);
}

.log-details {
  font-size: 0.95em;
  margin-bottom: 10px;
}

.log-status-text {
  font-weight: bold;
  text-transform: capitalize;
}

.log-status-text[data-status="started"] {
  color: #ffc107;
}
.log-status-text[data-status="completed"] {
  color: #28a745;
}
.log-status-text[data-status="failed"] {
  color: #dc3545;
}

.log-output-toggle {
  margin-top: 10px;
}

.log-output {
  background-color: var(--log-output-bg);
  color: var(--log-output-color);
  padding: 15px;
  border-radius: 5px;
  overflow-x: auto;
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 0.85em;
  margin-top: 10px;
}

.error {
  color: #dc3545;
}</style>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2 class="logo"><i class="fas fa-rocket"></i> CI/CD</h2>
        <button id="theme-toggle" class="button icon-button" aria-label="Toggle dark mode">
            <i class="fas fa-moon"></i>
        </button>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li><a href="#" id="nav-dashboard" class="active" data-section="dashboard-overview" data-title="Dashboard Overview"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="#" id="nav-projects" data-section="projects-management" data-title="Project Management"><i class="fas fa-folder-open"></i> Projects</a></li>
          <li><a href="#" id="nav-logs" data-section="logs-viewer" data-title="Full Log History"><i class="fas fa-clipboard-list"></i> Logs</a></li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button id="logout-button" class="button secondary full-width"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <div class="main-content-header">
        <h1 id="main-content-title" class="main-title">Dashboard Overview</h1>
      </div>
      <div class="container">
          <!-- Setup Section -->
          <section id="setup-section" class="hidden card">
              <h2><i class="fas fa-cogs"></i> Server Setup</h2>
              <form id="setup-form">
                  <div class="form-group">
                      <label for="setup-username">Username:</label>
                      <input type="text" id="setup-username" name="username" required>
                  </div>
                  <div class="form-group">
                      <label for="setup-password">Password:</label>
                      <input type="password" id="setup-password" name="password" required>
                  </div>
                  <button type="submit" class="button primary"><i class="fas fa-check-circle"></i> Setup Server</button>
                  <p id="setup-message" class="message"></p>
              </form>
          </section>

          <!-- Login Section -->
          <section id="login-section" class="hidden card">
              <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
              <form id="login-form">
                  <div class="form-group">
                      <label for="login-username">Username:</label>
                      <input type="text" id="login-username" name="username" required>
                  </div>
                  <div class="form-group">
                      <label for="login-password">Password:</label>
                      <input type="password" id="login-password" name="password" required>
                  </div>
                  <button type="submit" class="button primary"><i class="fas fa-sign-in-alt"></i> Login</button>
                  <p id="login-message" class="message"></p>
              </form>
          </section>

          <!-- Dashboard Section (Main content for logged-in users) -->
          <section id="dashboard-section" class="hidden">
              <div id="dashboard-overview" class="dashboard-sub-section">
                  <div class="card">
                      <div class="card-header">
                          <h3 id="project-form-title"><i class="fas fa-plus-circle"></i> Quick Add Project</h3>
                          <button id="toggle-project-form" class="button icon-button" aria-label="Toggle project form">
                              <i class="fas fa-chevron-down"></i>
                          </button>
                      </div>
                      <div id="project-form-container" class="hidden">
                          <form id="add-project-form">
                              <input type="hidden" id="original-project-name" name="originalName">
                              <div class="form-group">
                                  <label for="project-name">Project Name:</label>
                                  <input type="text" id="project-name" name="name" required>
                              </div>
                              <div class="form-group">
                                  <label for="project-repo">Repository URL:</label>
                                  <input type="url" id="project-repo" name="repo" required>
                              </div>
                              <div class="form-group">
                                  <label for="project-secret">Webhook Secret:</label>
                                  <input type="text" id="project-secret" name="secret" required>
                              </div>
                              <div class="form-group">
                                  <label for="project-commands">Commands (comma-separated):</label>
                                  <input type="text" id="project-commands" name="commands">
                              </div>
                              <div class="form-group">
                                  <label for="project-working-dir">Working Directory:</label>
                                  <input type="text" id="project-working-dir" name="workingDir" required>
                              </div>
                              <button type="submit" class="button primary" id="project-submit-button"><i class="fas fa-save"></i> Add Project</button>
                              <button type="button" class="button secondary hidden" id="cancel-edit-button"><i class="fas fa-times-circle"></i> Cancel Edit</button>
                              <p id="add-project-message" class="message"></p>
                          </form>
                      </div>
                  </div>

                  <div class="card">
                      <h3><i class="fas fa-folder-open"></i> Existing Projects</h3>
                      <ul id="projects-list" class="list">
                          <li class="list-item"><i class="fas fa-info-circle"></i> No projects added yet.</li>
                      </ul>
                  </div>

                  <div class="card">
                      <h3><i class="fas fa-clipboard-list"></i> Recent Logs</h3>
                      <ul id="logs-list" class="list logs-list">
                          <li class="list-item"><i class="fas fa-info-circle"></i> No logs available.</li>
                      </ul>
                  </div>
              </div>

              <div id="projects-management" class="dashboard-sub-section hidden">
                  <div class="card">
                      <div class="card-header">
                          <h3 id="project-form-title-alt"><i class="fas fa-plus-circle"></i> Add/Edit Project</h3>
                          <button id="toggle-project-form-alt" class="button icon-button" aria-label="Toggle project form">
                              <i class="fas fa-chevron-down"></i>
                          </button>
                      </div>
                      <div id="project-form-container-alt" class="hidden">
                          <form id="add-project-form-alt">
                              <input type="hidden" id="original-project-name-alt" name="originalName">
                              <div class="form-group">
                                  <label for="project-name-alt">Project Name:</label>
                                  <input type="text" id="project-name-alt" name="name" required>
                              </div>
                              <div class="form-group">
                                  <label for="project-repo-alt">Repository URL:</label>
                                  <input type="url" id="project-repo-alt" name="repo" required>
                              </div>
                              <div class="form-group">
                                  <label for="project-secret-alt">Webhook Secret:</label>
                                  <input type="text" id="project-secret-alt" name="secret" required>
                              </div>
                              <div class="form-group">
                                  <label for="project-commands-alt">Commands (comma-separated):</label>
                                  <input type="text" id="project-commands-alt" name="commands">
                              </div>
                              <div class="form-group">
                                  <label for="project-working-dir-alt">Working Directory:</label>
                                  <input type="text" id="project-working-dir-alt" name="workingDir" required>
                              </div>
                              <button type="submit" class="button primary" id="project-submit-button-alt"><i class="fas fa-save"></i> Add Project</button>
                              <button type="button" class="button secondary hidden" id="cancel-edit-button-alt"><i class="fas fa-times-circle"></i> Cancel Edit</button>
                              <p id="add-project-message-alt" class="message"></p>
                          </form>
                      </div>
                  </div>
                  <div class="card">
                      <h3><i class="fas fa-list-alt"></i> All Projects</h3>
                      <ul id="all-projects-list" class="list">
                          <li class="list-item"><i class="fas fa-info-circle"></i> No projects added yet.</li>
                      </ul>
                  </div>
              </div>

              <div id="logs-viewer" class="dashboard-sub-section hidden">
                  <div class="card">
                      <h3><i class="fas fa-history"></i> Full Log History</h3>
                      <ul id="full-logs-list" class="list logs-list">
                          <li class="list-item"><i class="fas fa-info-circle"></i> No logs available.</li>
                      </ul>
                  </div>
              </div>
          </section>
      </div>
    </main>
  </div>

  <script>
      const setupSection = document.getElementById('setup-section');
      const loginSection = document.getElementById('login-section');
      const dashboardSection = document.getElementById('dashboard-section');

      const setupForm = document.getElementById('setup-form');
      const loginForm = document.getElementById('login-form');
      const addProjectForm = document.getElementById('add-project-form'); // For dashboard overview
      const addProjectFormAlt = document.getElementById('add-project-form-alt'); // For projects management section

      const logoutButton = document.getElementById('logout-button');
      const projectFormTitle = document.getElementById('project-form-title');
      const projectSubmitButton = document.getElementById('project-submit-button');
      const cancelEditButton = document.getElementById('cancel-edit-button');
      const originalProjectNameInput = document.getElementById('original-project-name');
      const toggleProjectFormButton = document.getElementById('toggle-project-form');
      const projectFormContainer = document.getElementById('project-form-container');
      const themeToggleButton = document.getElementById('theme-toggle');

      // Elements for the alternative project form in "Projects" section
      const projectFormTitleAlt = document.getElementById('project-form-title-alt');
      const projectSubmitButtonAlt = document.getElementById('project-submit-button-alt');
      const cancelEditButtonAlt = document.getElementById('cancel-edit-button-alt');
      const originalProjectNameInputAlt = document.getElementById('original-project-name-alt');
      const toggleProjectFormButtonAlt = document.getElementById('toggle-project-form-alt');
      const projectFormContainerAlt = document.getElementById('project-form-container-alt');

      const mainContentTitle = document.getElementById('main-content-title');

      const setupMessage = document.getElementById('setup-message');
      const loginMessage = document.getElementById('login-message');
      const addProjectMessage = document.getElementById('add-project-message'); // For dashboard overview
      const addProjectMessageAlt = document.getElementById('add-project-message-alt'); // For projects management section

      const projectsList = document.getElementById('projects-list'); // For dashboard overview
      const allProjectsList = document.getElementById('all-projects-list'); // For projects management section
      const logsList = document.getElementById('logs-list'); // For dashboard overview
      const fullLogsList = document.getElementById('full-logs-list'); // For logs viewer section

      let isEditing = false;
      let currentEditForm = null; // To track which form is in edit mode

      // Theme Toggle Logic
      function applyTheme(theme) {
          document.body.classList.remove('light-mode', 'dark-mode');
          document.body.classList.add(theme);
          themeToggleButton.innerHTML = theme === 'dark-mode' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
          localStorage.setItem('theme', theme);
      }

      themeToggleButton.addEventListener('click', () => {
          const currentTheme = localStorage.getItem('theme') || 'light-mode';
          const newTheme = currentTheme === 'light-mode' ? 'dark-mode' : 'light-mode';
          applyTheme(newTheme);
      });

      // Apply saved theme on load
      const savedTheme = localStorage.getItem('theme') || 'light-mode';
      applyTheme(savedTheme);


      function showSection(section) {
          setupSection.classList.add('hidden');
          loginSection.classList.add('hidden');
          dashboardSection.classList.add('hidden');
          section.classList.remove('hidden');
      }

      function showDashboardSubSection(sectionId) {
          document.querySelectorAll('.dashboard-sub-section').forEach(sub => sub.classList.add('hidden'));
          document.getElementById(sectionId).classList.remove('hidden');

          document.querySelectorAll('.sidebar-nav a').forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector(`.sidebar-nav a[data-section="${sectionId}"]`);
          activeLink.classList.add('active');
          mainContentTitle.textContent = activeLink.dataset.title; // Update main content title
      }

      function resetProjectForm(formId) {
          const form = document.getElementById(formId);
          const titleElement = formId === 'add-project-form' ? projectFormTitle : projectFormTitleAlt;
          const submitButton = formId === 'add-project-form' ? projectSubmitButton : projectSubmitButtonAlt;
          const cancelButton = formId === 'add-project-form' ? cancelEditButton : cancelEditButtonAlt;
          const originalNameInput = formId === 'add-project-form' ? originalProjectNameInput : originalProjectNameInputAlt;
          const messageElement = formId === 'add-project-form' ? addProjectMessage : addProjectMessageAlt;
          const container = formId === 'add-project-form' ? projectFormContainer : projectFormContainerAlt;
          const toggleButton = formId === 'add-project-form' ? toggleProjectFormButton : toggleProjectFormButtonAlt;

          form.reset();
          titleElement.innerHTML = '<i class="fas fa-plus-circle"></i> ' + (formId === 'add-project-form' ? 'Quick Add Project' : 'Add/Edit Project');
          submitButton.innerHTML = '<i class="fas fa-save"></i> Add Project';
          submitButton.classList.remove('secondary');
          submitButton.classList.add('primary');
          cancelButton.classList.add('hidden');
          originalNameInput.value = '';
          form.querySelector('[name="name"]').readOnly = false;
          isEditing = false;
          currentEditForm = null;
          messageElement.textContent = '';
          container.classList.add('hidden');
          toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
      }

      // Toggle project form visibility
      toggleProjectFormButton.addEventListener('click', () => {
          projectFormContainer.classList.toggle('hidden');
          const isHidden = projectFormContainer.classList.contains('hidden');
          toggleProjectFormButton.innerHTML = isHidden ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-up"></i>';
      });

      toggleProjectFormButtonAlt.addEventListener('click', () => {
          projectFormContainerAlt.classList.toggle('hidden');
          const isHidden = projectFormContainerAlt.classList.contains('hidden');
          toggleProjectFormButtonAlt.innerHTML = isHidden ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-up"></i>';
      });


      async function checkAuthAndRender() {
          const loggedIn = localStorage.getItem('loggedIn');
          if (loggedIn === 'true') {
              try {
                  const response = await fetch('http://localhost:1000/api/projects');
                  if (response.ok) {
                      showSection(dashboardSection);
                      showDashboardSubSection('dashboard-overview'); // Default to overview
                      loadProjects();
                      loadLogs();
                  } else {
                      localStorage.removeItem('loggedIn');
                      checkAuthAndRender();
                  }
              } catch (error) {
                  console.error('Error checking auth:', error);
                  localStorage.removeItem('loggedIn');
                  checkAuthAndRender();
              }
          } else {
              // Corrected logic: Use /api/status to check initialization
              try {
                  const statusResponse = await fetch('http://localhost:1000/api/status');
                  const statusData = await statusResponse.json();
                  if (statusData.initialized) {
                      showSection(loginSection);
                  } else {
                      showSection(setupSection);
                  }
              } catch (error) {
                  console.error('Error checking server status:', error);
                  // Fallback to setup if status check fails (e.g., server not running)
                  showSection(setupSection);
              }
          }
      }

      setupForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(setupForm);
          const data = Object.fromEntries(formData.entries());

          try {
              const response = await fetch('http://localhost:1000/api/setup', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              });
              const result = await response.json();
              if (response.ok) {
                  setupMessage.textContent = result.message;
                  setupMessage.style.color = 'green';
                  setTimeout(() => {
                      showSection(loginSection);
                      setupMessage.textContent = '';
                      setupForm.reset();
                  }, 1500);
              } else {
                  setupMessage.textContent = result.message || 'Setup failed.';
                  setupMessage.style.color = 'red';
              }
          } catch (error) {
              setupMessage.textContent = 'Network error during setup.';
              setupMessage.style.color = 'red';
              console.error('Setup error:', error);
          }
      });

      loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(loginForm);
          const data = Object.fromEntries(formData.entries());

          try {
              const response = await fetch('http://localhost:1000/api/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              });
              const result = await response.json();
              if (response.ok) {
                  loginMessage.textContent = result.message;
                  loginMessage.style.color = 'green';
                  localStorage.setItem('loggedIn', 'true');
                  setTimeout(() => {
                      showSection(dashboardSection);
                      showDashboardSubSection('dashboard-overview'); // Default to overview after login
                      loginMessage.textContent = '';
                      loginForm.reset();
                      loadProjects();
                      loadLogs();
                  }, 500);
              } else {
                  loginMessage.textContent = result.message || 'Login failed.';
                  loginMessage.style.color = 'red';
              }
          } catch (error) {
              loginMessage.textContent = 'Network error during login.';
              loginMessage.style.color = 'red';
              console.error('Login error:', error);
          }
      });

      // Generic project form submission handler
      async function handleProjectFormSubmit(e, formId) {
          e.preventDefault();
          const form = document.getElementById(formId);
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          const projectName = data.name;
          const originalName = data.originalName;
          const messageElement = formId === 'add-project-form' ? addProjectMessage : addProjectMessageAlt;

          let url = '/api/project';
          let method = 'POST';

          if (isEditing && currentEditForm === formId) {
              url = `/api/project/${originalName}`;
              method = 'PUT';
          }

          try {
              const response = await fetch(url, {
                  method: method,
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              });
              const result = await response.json();
              if (response.ok) {
                  messageElement.textContent = result.message;
                  messageElement.style.color = 'green';
                  resetProjectForm(formId);
                  loadProjects(); // Reload both project lists
              } else {
                  messageElement.textContent = result.message || `Failed to ${isEditing && currentEditForm === formId ? 'update' : 'add'} project.`;
                  messageElement.style.color = 'red';
              }
          } catch (error) {
              messageElement.textContent = `Network error during project ${isEditing && currentEditForm === formId ? 'update' : 'addition'}.`;
              messageElement.style.color = 'red';
              console.error('Project form error:', error);
          }
      }

      addProjectForm.addEventListener('submit', (e) => handleProjectFormSubmit(e, 'add-project-form'));
      addProjectFormAlt.addEventListener('submit', (e) => handleProjectFormSubmit(e, 'add-project-form-alt'));


      logoutButton.addEventListener('click', () => {
          localStorage.removeItem('loggedIn');
          showSection(loginSection);
          resetProjectForm('add-project-form');
          resetProjectForm('add-project-form-alt');
      });

      cancelEditButton.addEventListener('click', () => resetProjectForm('add-project-form'));
      cancelEditButtonAlt.addEventListener('click', () => resetProjectForm('add-project-form-alt'));


      async function loadProjects() {
          try {
              const response = await fetch('http://localhost:1000/api/projects');
              const projects = await response.json();

              // Clear both lists
              projectsList.innerHTML = '';
              allProjectsList.innerHTML = '';

              if (Object.keys(projects).length === 0) {
                  projectsList.innerHTML = '<li class="list-item"><i class="fas fa-info-circle"></i> No projects added yet.</li>';
                  allProjectsList.innerHTML = '<li class="list-item"><i class="fas fa-info-circle"></i> No projects added yet.</li>';
                  return;
              }

              for (const name in projects) {
                  const project = projects[name];
                  const listItemHtml = `
                      <strong><i class="fas fa-project-diagram"></i> ${name}</strong><br>
                      Repo: <a href="${project.repo}" target="_blank">${project.repo}</a><br>
                      Commands: <code>${project.commands.join(', ')}</code><br>
                      Working Dir: <code>${project.workingDir}</code><br>
                      Webhook URL: <code>${window.location.origin}/webhook</code>
                      <div class="project-actions">
                          <button class="button small edit-project-button" data-name="${name}"><i class="fas fa-edit"></i> Edit</button>
                          <button class="button small danger delete-project-button" data-name="${name}"><i class="fas fa-trash-alt"></i> Delete</button>
                      </div>
                  `;

                  const listItemOverview = document.createElement('li');
                  listItemOverview.className = 'list-item';
                  listItemOverview.innerHTML = listItemHtml;
                  projectsList.appendChild(listItemOverview);

                  const listItemAll = document.createElement('li');
                  listItemAll.className = 'list-item';
                  listItemAll.innerHTML = listItemHtml;
                  allProjectsList.appendChild(listItemAll);
              }

              // Attach event listeners to new buttons for both lists
              document.querySelectorAll('.edit-project-button').forEach(button => {
                  button.addEventListener('click', (e) => {
                      const projectName = e.target.dataset.name;
                      // Always target the 'alt' form for editing and switch to projects management
                      editProject(projectName, 'add-project-form-alt');
                      showDashboardSubSection('projects-management');
                  });
              });
              document.querySelectorAll('.delete-project-button').forEach(button => {
                  button.addEventListener('click', (e) => {
                      const projectName = e.target.dataset.name;
                      deleteProject(projectName);
                  });
              });

          } catch (error) {
              projectsList.innerHTML = '<li class="list-item error"><i class="fas fa-exclamation-triangle"></i> Error loading projects.</li>';
              allProjectsList.innerHTML = '<li class="list-item error"><i class="fas fa-exclamation-triangle"></i> Error loading projects.</li>';
              console.error('Error loading projects:', error);
          }
      }

      async function editProject(name, formId) {
          try {
              const response = await fetch('http://localhost:1000/api/projects');
              const projects = await response.json();
              const project = projects[name];

              if (project) {
                  const form = document.getElementById(formId);
                  const titleElement = formId === 'add-project-form' ? projectFormTitle : projectFormTitleAlt;
                  const submitButton = formId === 'add-project-form' ? projectSubmitButton : projectSubmitButtonAlt;
                  const cancelButton = formId === 'add-project-form' ? cancelEditButton : cancelEditButtonAlt;
                  const originalNameInput = formId === 'add-project-form' ? originalProjectNameInput : originalProjectNameInputAlt;
                  const container = formId === 'add-project-form' ? projectFormContainer : projectFormContainerAlt;
                  const toggleButton = formId === 'add-project-form' ? toggleProjectFormButton : toggleProjectFormButtonAlt;

                  // Reset the other form if it was in edit mode
                  const otherFormId = formId === 'add-project-form' ? 'add-project-form-alt' : 'add-project-form';
                  if (isEditing && currentEditForm === otherFormId) {
                      resetProjectForm(otherFormId);
                  }

                  form.querySelector('[name="name"]').value = name;
                  form.querySelector('[name="name"]').readOnly = true;
                  form.querySelector('[name="repo"]').value = project.repo;
                  form.querySelector('[name="secret"]').value = project.secret;
                  form.querySelector('[name="commands"]').value = project.commands.join(', ');
                  form.querySelector('[name="workingDir"]').value = project.workingDir;
                  originalNameInput.value = name;

                  titleElement.innerHTML = `<i class="fas fa-edit"></i> Edit Project: ${name}`;
                  submitButton.innerHTML = '<i class="fas fa-save"></i> Update Project';
                  submitButton.classList.remove('primary');
                  submitButton.classList.add('secondary');
                  cancelButton.classList.remove('hidden');
                  isEditing = true;
                  currentEditForm = formId;
                  (formId === 'add-project-form' ? addProjectMessage : addProjectMessageAlt).textContent = ''; // Clear previous messages
                  container.classList.remove('hidden'); // Show form when editing
                  toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i>'; // Set toggle icon to up
              } else {
                  alert('Project not found for editing.');
              }
          } catch (error) {
              console.error('Error fetching project for edit:', error);
              alert('Could not load project details for editing.');
          }
      }

      async function deleteProject(name) {
          if (confirm(`Are you sure you want to delete project "${name}"? This action cannot be undone.`)) {
              try {
                  const response = await fetch(`http://localhost:1000/api/project/${name}`, {
                      method: 'DELETE',
                  });
                  const result = await response.json();
                  if (response.ok) {
                      alert(result.message);
                      loadProjects();
                      resetProjectForm('add-project-form');
                      resetProjectForm('add-project-form-alt');
                  } else {
                      alert(result.message || 'Failed to delete project.');
                  }
              } catch (error) {
                  alert('Network error during project deletion.');
                  console.error('Delete project error:', error);
              }
          }
      }

      async function loadLogs() {
          try {
              const response = await fetch('http://localhost:1000/api/logs');
              const logs = await response.json();

              // Clear both lists
              logsList.innerHTML = '';
              fullLogsList.innerHTML = '';

              if (logs.length === 0) {
                  logsList.innerHTML = '<li class="list-item"><i class="fas fa-info-circle"></i> No logs available.</li>';
                  fullLogsList.innerHTML = '<li class="list-item"><i class="fas fa-info-circle"></i> No logs available.</li>';
                  return;
              }
              logs.forEach(log => {
                  const listItem = document.createElement('li');
                  listItem.className = `list-item log-item log-status-${log.status || 'unknown'}`;
                  const date = new Date(log.time).toLocaleString();
                  let statusIcon = '';
                  if (log.status === 'started') statusIcon = '<i class="fas fa-hourglass-start"></i>';
                  else if (log.status === 'completed') statusIcon = '<i class="fas fa-check-circle"></i>';
                  else if (log.status === 'failed') statusIcon = '<i class="fas fa-times-circle"></i>';
                  else statusIcon = '<i class="fas fa-question-circle"></i>';

                  const logHtml = `
                      <div class="log-header">
                          <span><strong><i class="fas fa-code-branch"></i> ${log.repo.split('/').pop()}</strong> - ${log.branch}</span>
                          <span class="log-time"><i class="fas fa-clock"></i> ${date}</span>
                      </div>
                      <div class="log-details">
                          Commit: <i class="fas fa-hashtag"></i> ${log.commit || 'N/A'}<br>
                          Author: <i class="fas fa-user"></i> ${log.author || 'N/A'}<br>
                          Status: <span class="log-status-text" data-status="${log.status || 'unknown'}">${statusIcon} ${log.status || 'N/A'}</span>
                      </div>
                      ${log.output && log.output.length > 0 ? `
                          <div class="log-output-toggle">
                              <button class="button small toggle-output-button"><i class="fas fa-terminal"></i> Show Output</button>
                              <pre class="log-output hidden">${log.output.map(o => `Command: ${o.command}\nSTDOUT:\n${o.stdout}\nSTDERR:\n${o.error ? `ERROR: ${o.error}\n` : ''}`).join('\n-------------------\n')}</pre>
                          </div>
                      ` : ''}
                  `;

                  const listItemOverview = document.createElement('li');
                  listItemOverview.className = listItem.className;
                  listItemOverview.innerHTML = logHtml;
                  logsList.appendChild(listItemOverview);

                  const listItemFull = document.createElement('li');
                  listItemFull.className = listItem.className;
                  listItemFull.innerHTML = logHtml;
                  fullLogsList.appendChild(listItemFull);
              });

              document.querySelectorAll('.toggle-output-button').forEach(button => {
                  button.addEventListener('click', (e) => {
                      const outputPre = e.target.nextElementSibling;
                      outputPre.classList.toggle('hidden');
                      e.target.innerHTML = outputPre.classList.contains('hidden') ? '<i class="fas fa-terminal"></i> Show Output' : '<i class="fas fa-terminal"></i> Hide Output';
                  });
              });

          } catch (error) {
              logsList.innerHTML = '<li class="list-item error"><i class="fas fa-exclamation-triangle"></i> Error loading logs.</li>';
              fullLogsList.innerHTML = '<li class="list-item error"><i class="fas fa-exclamation-triangle"></i> Error loading logs.</li>';
              console.error('Error loading logs:', error);
          }
      }

      // Sidebar Navigation
      document.querySelectorAll('.sidebar-nav a').forEach(link => {
          link.addEventListener('click', (e) => {
              e.preventDefault();
              const targetSectionId = e.currentTarget.dataset.section;
              showDashboardSubSection(targetSectionId);
          });
      });


      checkAuthAndRender();
      setInterval(loadLogs, 10000);
  </script>
</body>
</html>
